<!DOCTYPE html>
<html>
<head>
    <title>OAuth Callback</title>
    <script>
        window.onload = function() {
            console.log('Callback page loaded');
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            
            document.getElementById('status').textContent = 'Processing...';
            
            if (error) {
                console.error('Error:', error);
                document.getElementById('status').textContent = 'Error: ' + error;
                return;
            }
            
            if (code) {
                console.log('Code received:', code);
                document.getElementById('status').textContent = 'Code received, redirecting...';
                
                // Try both URL schemes
                try {
                    window.location.href = `misfits://callback?code=${code}`;
                } catch (e) {
                    console.error('Failed primary redirect:', e);
                    try {
                        // Fallback
                        window.location.replace(`misfits://callback?code=${code}`);
                    } catch (e2) {
                        console.error('Failed fallback redirect:', e2);
                        document.getElementById('status').textContent = 'Redirect failed. Please return to the app.';
                    }
                }
            } else {
                console.log('No code found');
                document.getElementById('status').textContent = 'No authorization code received';
            }
        }
    </script>
</head>
<body>
    <h1>IOT Misfits Authorization</h1>
    <p>Processing Garmin authentication...</p>
    <div id="status" style="margin-top: 20px; color: blue;"></div>
    <div id="debug" style="margin-top: 20px; font-family: monospace;"></div>
</body>
</html>
